<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bee Ruler - Debug Version</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        canvas { border: 2px solid black; max-width: 100%; display: block; margin: 20px 0; }
        input, button { padding: 10px; margin: 10px 0; font-size: 16px; }
        .message { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üêù Bee Image Ruler - Test Version</h1>
    
    <div>
        <label>Upload Image (JPG or PNG):</label><br>
        <input type="file" id="imageFile" accept="image/*">
    </div>

    <div id="messages"></div>

    <canvas id="canvas"></canvas>

    <div>
        <p><strong>Instructions:</strong></p>
        <ol>
            <li>Upload a JPG or PNG image</li>
            <li>The image should appear on the canvas below</li>
            <li>Click two points on a reference object (ruler, card, etc.)</li>
            <li>Enter the actual size and unit</li>
            <li>Click "Apply Calibration"</li>
        </ol>
    </div>

    <div id="calibrationSection" style="display: none;">
        <h3>Calibration</h3>
        <p id="pointsInfo">Points clicked: 0/2</p>
        
        <div>
            <label>Reference Object Size:</label><br>
            <input type="number" id="size" placeholder="Enter size" step="0.01" min="0">
            <select id="unit">
                <option value="mm">mm</option>
                <option value="cm">cm</option>
                <option value="inches">inches</option>
            </select>
            <button onclick="applyCalibration()">Apply Calibration</button>
            <button onclick="resetAll()">Reset</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const imageFile = document.getElementById('imageFile');
        const messagesDiv = document.getElementById('messages');
        const calibrationSection = document.getElementById('calibrationSection');

        let img = null;
        let points = [];
        let pixelsPerMM = null;

        function addMessage(text, type = 'info') {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;
            messagesDiv.appendChild(msg);
            setTimeout(() => msg.remove(), 5000);
        }

        imageFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            addMessage(`File selected: ${file.name}`, 'info');
            
            if (!file) {
                addMessage('No file selected', 'error');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = (event) => {
                addMessage('File read successfully, creating image...', 'info');
                img = new Image();
                
                img.onload = () => {
                    addMessage(`Image loaded! Size: ${img.width}x${img.height}px`, 'success');
                    drawImage();
                    calibrationSection.style.display = 'block';
                };
                
                img.onerror = () => {
                    addMessage('Error: Could not load image', 'error');
                };
                
                img.src = event.target.result;
            };
            
            reader.onerror = () => {
                addMessage('Error: Could not read file', 'error');
            };
            
            reader.readAsDataURL(file);
        });

        function drawImage() {
            if (!img) return;
            
            // Set canvas size
            const maxWidth = 700;
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
                const ratio = maxWidth / width;
                width = maxWidth;
                height = height * ratio;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Draw image
            ctx.drawImage(img, 0, 0, width, height);
            addMessage(`Canvas drawn: ${width}x${height}px`, 'success');
            
            // Draw points if any exist
            drawPoints();
        }

        function drawPoints() {
            points.forEach((p, i) => {
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(p.x, p.y, 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText((i + 1), p.x, p.y);
            });
            
            if (points.length === 2) {
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                ctx.lineTo(points[1].x, points[1].y);
                ctx.stroke();
            }
        }

        canvas.addEventListener('click', (e) => {
            if (!img) {
                addMessage('Please upload an image first', 'error');
                return;
            }
            
            if (points.length >= 2) {
                addMessage('Two points already selected. Click Reset to try again.', 'error');
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            points.push({x, y});
            addMessage(`Point ${points.length} clicked at (${Math.round(x)}, ${Math.round(y)})`, 'success');
            
            document.getElementById('pointsInfo').textContent = `Points clicked: ${points.length}/2`;
            drawImage();
        });

        function applyCalibration() {
            if (points.length !== 2) {
                addMessage('Please click exactly 2 points', 'error');
                return;
            }
            
            const size = parseFloat(document.getElementById('size').value);
            const unit = document.getElementById('unit').value;
            
            if (!size || size <= 0) {
                addMessage('Please enter a valid size', 'error');
                return;
            }
            
            let sizeInMM = size;
            if (unit === 'cm') sizeInMM = size * 10;
            else if (unit === 'inches') sizeInMM = size * 25.4;
            
            const p1 = points[0];
            const p2 = points[1];
            const distance = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
            
            pixelsPerMM = distance / sizeInMM;
            
            addMessage(`‚úÖ Calibrated! 1 pixel = ${(1/pixelsPerMM).toFixed(4)} mm`, 'success');
            points = [];
            document.getElementById('pointsInfo').textContent = 'Points clicked: 0/2';
        }

        function resetAll() {
            img = null;
            points = [];
            pixelsPerMM = null;
            canvas.width = 0;
            canvas.height = 0;
            imageFile.value = '';
            calibrationSection.style.display = 'none';
            document.getElementById('size').value = '';
            addMessage('Reset complete', 'info');
        }
    </script>
</body>
</html>
